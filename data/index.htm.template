<!DOCTYPE html>
<html charset="UTF-8" lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DIY Battery BMS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header img {
      max-width: 200px;
      margin-bottom: 15px;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 5px;
    }
    
    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      background: #f8f8f8;
      flex-wrap: wrap;
    }
    
    .tab-button {
      flex: 1;
      min-width: 120px;
      padding: 15px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }
    
    .tab-button:hover {
      background: #f0f0f0;
      color: #667eea;
    }
    
    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: white;
    }
    
    .content {
      padding: 30px;
    }
    
    .tab-pane {
      display: none;
    }
    
    .tab-pane.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-row.full {
      grid-template-columns: 1fr;
    }
    
    .stat-box {
      background: #f8f8f8;
      border-radius: 8px;
      padding: 20px 15px;
      text-align: center;
      margin-bottom: 15px;
      position: relative;
      border-left: 4px solid #667eea;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      min-height: 100px;
    }

    .stat-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
    }

    .stat-box.clickable {
      cursor: pointer;
    }

    .stat-box.clickable:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }

    .stat-box.clickable:active {
      transform: translateY(-1px);
    }

    .stat-label {
      font-size: 20px;
      color: #666;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 20px;
      color: #667eea;
      font-weight: 700;
      line-height: 1.2;
    }

    /* Battery Visual Indicator */
    .battery-visual {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
      gap: 0;
    }

    .battery-container {
      position: relative;
      width: 220px;
      height: 100px;
      border: 4px solid #667eea;
      border-radius: 8px;
      overflow: hidden;
      background: #f0f0f0;
    }

    .battery-level {
      height: 100%;
      background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
      transition: width 0.5s ease, background 0.3s ease;
      position: absolute;
      left: 0;
      top: 0;
    }

    .battery-level.low { background: linear-gradient(90deg, #f44336 0%, #e91e63 100%); }
    .battery-level.medium { background: linear-gradient(90deg, #ff9800 0%, #ffc107 100%); }
    .battery-level.high { background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%); }

    /* Battery Wave Animation */
    .battery-wave {
      position: absolute;
      width: 200%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0.3;
      display: none;
    }

    .battery-wave.active {
      display: block;
    }

    .battery-wave::before {
      content: '';
      position: absolute;
      width: 200%;
      height: 100%;
      top: 0;
      left: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
      animation: wave 2s linear infinite;
    }

    .battery-wave.charging {
      animation: waveUp 1.5s ease-in-out infinite;
    }

    .battery-wave.discharging {
      animation: waveDown 1.5s ease-in-out infinite;
    }

    @keyframes wave {
      0% { transform: translateX(-50%); }
      100% { transform: translateX(0); }
    }

    @keyframes waveUp {
      0%, 100% { transform: translateY(3px); }
      50% { transform: translateY(-3px); }
    }

    @keyframes waveDown {
      0%, 100% { transform: translateY(-3px); }
      50% { transform: translateY(3px); }
    }

    .battery-percentage {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 100px;
      font-size: 38px;
      font-weight: 700;
      color: #333;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(255,255,255,0.8);
    }

    .battery-tip {
      width: 12px;
      height: 40px;
      background: #667eea;
      border-radius: 0 4px 4px 0;
      margin-left: -2px;
    }

    /* Power Flow Indicator - Compact */
    .power-flow-indicator {
      text-align: center;
      margin: 10px 0;
      padding: 8px 15px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 6px;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }

    .flow-text {
      font-size: 18px;
      font-weight: 700;
      color: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .flow-text::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .flow-text.charging::before {
      animation: pulse 1s infinite;
    }

    .flow-text.discharging::before {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.3; transform: scale(1.5); }
    }

    /* Status Warnings */
    .status-warnings {
      margin-top: 20px;
      padding: 15px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 6px;
      animation: fadeIn 0.3s ease;
    }

    .status-warnings.error {
      background: #f8d7da;
      border-left-color: #f44336;
    }

    .warning-box {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #856404;
      font-weight: 500;
    }

    .status-warnings.error .warning-box {
      color: #721c24;
    }

    .warning-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    /* Last Update Timestamp */
    .last-update {
      text-align: center;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
      color: #999;
      font-size: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
      font-size: 22px;
    }
    
    input[type="text"],
    input[type="textbox"],
    input[type="password"],
    input[type="number"],
    input[type="file"],
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    input[type="text"]:focus,
    input[type="textbox"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .password-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .password-wrapper input[type="password"],
    .password-wrapper input[type="text"] {
      padding-right: 45px;
    }
    
    .password-toggle {
      position: absolute;
      right: 8px;
      cursor: pointer;
      color: #667eea;
      font-size: 12px;
      font-weight: 600;
      user-select: none;
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid #667eea;
      border-radius: 4px;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: auto;
      height: 28px;
      box-shadow: none;
      transition: all 0.2s ease;
    }
    
    .password-toggle:hover {
      color: #764ba2;
      transform: none;
      box-shadow: none;
    }
    
    .password-toggle:active {
      transform: none;
    }
    
    button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      color: #fff;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 2000;
      min-width: 160px;
      text-align: center;
      font-weight: 500;
    }
    .toast.show { opacity: 1; }
    .toast.success { background: #28a745; }
    .toast.pending { background: #ffc107; color: #333; }
    .toast.error { background: #dc3545; }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #667eea;
      margin-top: 25px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .log-viewer {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 15px;
      height: 500px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      color: #d4d4d4;
      line-height: 1.5;
    }
    
    .log-entry {
      margin-bottom: 4px;
      word-wrap: break-word;
    }
    
    .log-entry.error { color: #f48771; }
    .log-entry.warning { color: #dcdcaa; }
    .log-entry.info { color: #4ec9b0; }
    .log-entry.debug { color: #9cdcfe; }
    
    .log-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    .log-controls button {
      padding: 8px 16px;
      font-size: 13px;
    }
    
    .log-controls label {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .section-title:first-child {
      margin-top: 0;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .button-group button {
      flex: 1;
      min-width: 150px;
    }
    
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .checkbox-row label {
      margin-bottom: 0;
    }
    
    .wifi-controls {
      display: flex;
      gap: 10px;
    }
    
    .wifi-controls select {
      flex: 1;
    }
    
    .wifi-controls button {
      flex: 0;
      padding: 10px 20px;
    }
    
    .save-btn {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      padding: 12px 30px;
      font-weight: 600;
      margin-top: 10px;
    }
    
    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>DIY Battery BMS</h1>
      <p>System Control & Configuration</p>
    </div>
    
    <div class="tabs">
      <button class="tab-button active" onclick="switchTab(event, 'home')">Home</button>
      <button class="tab-button" onclick="switchTab(event, 'bms')">BMS</button>
      <button class="tab-button" onclick="switchTab(event, 'settings')">Settings</button>
      <button class="tab-button" onclick="switchTab(event, 'wifimqtt')">WiFi/MQTT</button>
      <button class="tab-button" onclick="switchTab(event, 'logs')">Logs</button>
      <button class="tab-button" onclick="switchTab(event, 'firmware')">Firmware</button>
    </div>
    
    <div class="content">
      <!-- Home Tab -->
      <div id="home" class="tab-pane active">
        <h2 style="margin-bottom: 20px; color: #667eea;">Battery Status</h2>

        <!-- Visual Battery Indicator -->
        <div class="battery-visual">
          <div class="battery-container">
            <div class="battery-level" id="batteryLevel" style="width: 0%"></div>
            <div class="battery-wave" id="batteryWave"></div>
            <div class="battery-percentage" id="batteryPercentage">0%</div>
          </div>
          <div class="battery-tip"></div>
        </div>

        <!-- Power Flow Indicator - Compact -->
        <div class="power-flow-indicator">
          <div id="powerFlowText" class="flow-text">Idle</div>
        </div>

        <!-- Status Warnings (hidden by default) -->
        <div id="statusWarnings" class="status-warnings" style="display: none;">
          <div class="warning-box">
            <span class="warning-icon">&#9888;</span>
            <span id="warningText">System warning</span>
          </div>
        </div>

        <div class="form-row">
          <div class="stat-box">
            <div class="stat-label">Battery Voltage</div>
            <div class="stat-value"><label id="battvoltage">0</label>V</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Battery Current</div>
            <div class="stat-value"><label id="battcurrent">0</label>A</div>
          </div>
        </div>

        <div class="form-row">
          <div class="stat-box">
            <div class="stat-label">Charge Limit</div>
            <div class="stat-value"><label id="chargecurrent">0</label>A</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Discharge Limit</div>
            <div class="stat-value"><label id="dischargecurrent">0</label>A</div>
          </div>
        </div>

        <div class="form-row">
          <div class="stat-box clickable" onclick="toggleChargeEnable()">
            <div class="stat-label">Charge Enabled</div>
            <div class="stat-value" id="chargeenabledStatus" style="font-size: 16px; color: #f44336;">OFF</div>
          </div>
          <div class="stat-box clickable" onclick="toggleDischargeEnable()">
            <div class="stat-label">Discharge Enabled</div>
            <div class="stat-value" id="dischargeenabledStatus" style="font-size: 16px; color: #f44336;">OFF</div>
          </div>
        </div>

        <!-- Last Update Timestamp -->
        <div class="last-update">
          Last updated: <span id="lastUpdate">--</span>
        </div>
      </div>
      
      <!-- BMS Tab -->
      <div id="bms" class="tab-pane">
        <div class="section-title">Voltage Configuration</div>
        <div class="form-row">
          <div class="form-group">
            <label for="chargevoltage">Charge Voltage (mV):</label>
            <input type="number" id="chargevoltage" onchange="EnqueueUpdate('chargevoltage')" onkeypress="HandleEnter(event, 'chargevoltage')">
          </div>
          <div class="form-group">
            <label for="dischargevoltage">Discharge Voltage (mV):</label>
            <input type="number" id="dischargevoltage" onchange="EnqueueUpdate('dischargevoltage')" onkeypress="HandleEnter(event, 'dischargevoltage')">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="fullvoltage">Battery Full Voltage (mV):</label>
            <input type="number" id="fullvoltage" onchange="EnqueueUpdate('fullvoltage')" onkeypress="HandleEnter(event, 'fullvoltage')">
          </div>
          <div class="form-group">
            <label for="overvoltage">Battery Over Voltage (mV):</label>
            <input type="number" id="overvoltage" onchange="EnqueueUpdate('overvoltage')" onkeypress="HandleEnter(event, 'overvoltage')">
          </div>
        </div>
        
        <div class="section-title">Current Configuration</div>
        <div class="form-row">
          <div class="form-group">
            <label for="maxchargecurrent">Max Charge (mA):</label>
            <input type="number" id="maxchargecurrent" onchange="EnqueueUpdate('maxchargecurrent')" onkeypress="HandleEnter(event, 'maxchargecurrent')">
          </div>
          <div class="form-group">
            <label for="maxdischargecurrent">Max Discharge (mA):</label>
            <input type="number" id="maxdischargecurrent" onchange="EnqueueUpdate('maxdischargecurrent')" onkeypress="HandleEnter(event, 'maxdischargecurrent')">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="adjuststep">Charge Adjust Step (mA):</label>
            <input type="number" id="adjuststep" onchange="EnqueueUpdate('adjuststep')" onkeypress="HandleEnter(event, 'adjuststep')">
          </div>
          <div class="form-group">
            <label for="minchargecurr">Min Charge (mA):</label>
            <input type="number" id="minchargecurr" onchange="EnqueueUpdate('minchargecurr')" onkeypress="HandleEnter(event, 'minchargecurr')">
          </div>
        </div>
        
        <div class="form-row full">
          <div class="form-group">
            <label for="batterycapacity">Battery Capacity (mA):</label>
            <input type="number" id="batterycapacity" onchange="EnqueueUpdate('batterycapacity')" onkeypress="HandleEnter(event, 'batterycapacity')">
          </div>
        </div>
        
        <div class="section-title">SOC Limits</div>
        <div class="form-row">
          <div class="form-group">
            <label for="lowsoclimit">Low SOC (Stop Discharge):</label>
            <input type="number" id="lowsoclimit" onchange="EnqueueUpdate('lowsoclimit')" onkeypress="HandleEnter(event, 'lowsoclimit')">
          </div>
          <div class="form-group">
            <label for="highsoclimit">High SOC (Stop Charge):</label>
            <input type="number" id="highsoclimit" onchange="EnqueueUpdate('highsoclimit')" onkeypress="HandleEnter(event, 'highsoclimit')">
          </div>
        </div>
        
        <div class="section-title">Slow Charge Configuration</div>
        <div class="form-row">
          <div class="form-group">
            <label for="slowchargesoc1">Slow Charge SOC 1:</label>
            <input type="number" id="slowchargesoc1" onchange="EnqueueUpdate('slowchargesoc1')" onkeypress="HandleEnter(event, 'slowchargesoc1')">
          </div>
          <div class="form-group">
            <label for="slowchargesoc1div">Slow Charge 1 (divider):</label>
            <input type="number" id="slowchargesoc1div" onchange="EnqueueUpdate('slowchargesoc1div')" onkeypress="HandleEnter(event, 'slowchargesoc1div')">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="slowchargesoc2">Slow Charge SOC 2:</label>
            <input type="number" id="slowchargesoc2" onchange="EnqueueUpdate('slowchargesoc2')" onkeypress="HandleEnter(event, 'slowchargesoc2')">
          </div>
          <div class="form-group">
            <label for="slowchargesoc2div">Slow Charge 2 (divider):</label>
            <input type="number" id="slowchargesoc2div" onchange="EnqueueUpdate('slowchargesoc2div')" onkeypress="HandleEnter(event, 'slowchargesoc2div')">
          </div>
        </div>
        
        <div class="section-title">Advanced Settings</div>
        <div class="form-row">
          <div class="checkbox-row">
            <input type="checkbox" id="autocharge" onchange="SendJSONUpdate('autocharge')">
            <label for="autocharge">Smart Adjust Enabled</label>
          </div>
          <div class="form-group">
            <label for="smartinterval">Smart Interval (seconds):</label>
            <input type="number" id="smartinterval" onchange="EnqueueUpdate('smartinterval')" onkeypress="HandleEnter(event, 'smartinterval')">
          </div>
        </div>
        
        <div class="button-group">
          <button onclick="saveAll()">Save to EEPROM</button>
          <button onclick="eraseAll()">Factory Reset</button>
          <button onclick="rebootBMS()">Reboot & Apply</button>
        </div>
      </div>
      
      <!-- Settings Tab -->
      <div id="settings" class="tab-pane">
        <div class="section-title">CAN Bus Configuration</div>
        <div class="checkbox-row">
          <input type="checkbox" id="canbusenabled" onchange="SendJSONUpdate('canbusenabled')">
          <label for="canbusenabled">CAN Bus Enabled</label>
        </div>
        
        <div class="section-title">Victron Configuration</div>
        <div class="form-row">
          <div class="form-group">
            <label for="victronrxpin">Victron RX Pin:</label>
            <input type="number" id="victronrxpin" onchange="EnqueueUpdate('victronrxpin')" onkeypress="HandleEnter(event, 'victronrxpin')">
          </div>
          <div class="form-group">
            <label for="victrontxpin">Victron TX Pin:</label>
            <input type="number" id="victrontxpin" onchange="EnqueueUpdate('victrontxpin')" onkeypress="HandleEnter(event, 'victrontxpin')">
          </div>
        </div>
        
        <!-- BEGIN_CAN_CONFIG -->
        <div class="section-title">{{CAN_CONFIG_TITLE}}</div>
        <div class="form-row">
          {{CAN_CONFIG_FIELDS}}
        </div>
        <!-- END_CAN_CONFIG -->
        
        <div class="section-title">Protocol Settings</div>
        <div class="checkbox-row">
          <input type="checkbox" id="soctrickenabled" onchange="SendJSONUpdate('soctrickenabled')">
          <label for="soctrickenabled">SOC Trick Enable (1/10 SOC for Force Charge)</label>
        </div>
        
        <div class="checkbox-row">
          <input type="checkbox" id="requestflagsenabled" onchange="SendJSONUpdate('requestflagsenabled')">
          <label for="requestflagsenabled">Request Flags Enable (0x308 Status)</label>
        </div>
        
        <div class="section-title">Other Settings</div>
        <div class="form-row">
          {{FAN_PIN_FIELD}}
        </div>
        <div class="checkbox-row">
          <input type="checkbox" id="lcdenabled" onchange="SendJSONUpdate('lcdenabled')">
          <label for="lcdenabled">LCD Enabled</label>
        </div>
        
        <div class="section-title">Network Configuration</div>
        <div class="form-group">
          <label for="ntpserver">NTP Server:</label>
          <input type="textbox" id="ntpserver" onchange="EnqueueUpdate('ntpserver')" onkeypress="HandleEnter(event, 'ntpserver')">
        </div>
        
        <div class="button-group">
          <button onclick="eraseAll()">Factory Reset</button>
          <button onclick="erasekeepwifi()">Factory Reset Keeping WiFi</button>
          <button onclick="rebootBMS()">Reboot & Apply</button>
        </div>
      </div>
      
      <!-- WiFi/MQTT Tab -->
      <div id="wifimqtt" class="tab-pane">
        <div class="section-title">WiFi Configuration</div>
        <div class="form-group">
          <label for="wifissid">WiFi Network:</label>
          <div class="wifi-controls">
            <select id="wifissid"></select>
            <button onclick="GetWifiList()">Scan</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="wifipass">WiFi Password:</label>
          <div class="password-wrapper">
            <input type="password" id="wifipass" onkeypress="HandleEnter(event, 'SaveWifiConfig')">
            <button type="button" class="password-toggle" onclick="togglePassword('wifipass')">Show</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="wifihostname">mDNS Hostname:</label>
          <input type="textbox" id="wifihostname" onkeypress="HandleEnter(event, 'SaveWifiConfig')">
        </div>
        
        <div class="form-group">
          <button onclick="SaveWifiConfig()" class="save-btn">Save WiFi Configuration</button>
        </div>
        
        <div class="section-title">MQTT Server Configuration</div>
        <div class="form-row">
          <div class="form-group">
            <label for="mqttserverip">MQTT Server IP:</label>
            <input type="textbox" id="mqttserverip" onchange="EnqueueUpdate('mqttserverip')" onkeypress="HandleEnter(event, 'mqttserverip')">
          </div>
          <div class="form-group">
            <label for="mqttport">MQTT Port:</label>
            <input type="number" id="mqttport" onchange="EnqueueUpdate('mqttport')" onkeypress="HandleEnter(event, 'mqttport')">
          </div>
        </div>
        
        <div class="form-group">
          <label for="mqttclientid">MQTT Client ID:</label>
          <input type="textbox" id="mqttclientid" onchange="EnqueueUpdate('mqttclientid')" onkeypress="HandleEnter(event, 'mqttclientid')">
        </div>
        
        <div class="section-title">MQTT Topic Configuration</div>
        <div class="form-row">
          <div class="form-group">
            <label for="mqtttopic">MQTT Topic:</label>
            <input type="textbox" id="mqtttopic" onchange="EnqueueUpdate('mqtttopic')" onkeypress="HandleEnter(event, 'mqtttopic')">
          </div>
          <div class="form-group">
            <label for="mqttparameter">MQTT Parameter:</label>
            <input type="textbox" id="mqttparameter" onchange="EnqueueUpdate('mqttparameter')" onkeypress="HandleEnter(event, 'mqttparameter')">
          </div>
        </div>
        
        <div class="section-title">MQTT Authentication (Optional)</div>
        <div class="form-row">
          <div class="form-group">
            <label for="mqttuser">MQTT Username:</label>
            <input type="textbox" id="mqttuser" onchange="EnqueueUpdate('mqttuser')" onkeypress="HandleEnter(event, 'mqttuser')">
          </div>
          <div class="form-group">
            <label for="mqttpass">MQTT Password:</label>
            <div class="password-wrapper">
              <input type="password" id="mqttpass" onchange="EnqueueUpdate('mqttpass')" onkeypress="HandleEnter(event, 'mqttpass')">
              <button type="button" class="password-toggle" onclick="togglePassword('mqttpass')">Show</button>
            </div>
          </div>
        </div>
        
        <div class="section-title">Update Interval</div>
        <div class="form-group">
          <label for="velooptime">WiFi and MQTT Refresh Rate (seconds):</label>
          <input type="number" id="velooptime" onchange="EnqueueUpdate('velooptime')" onkeypress="HandleEnter(event, 'velooptime')">
        </div>
        
        <div class="button-group">
          <button onclick="rebootBMS()">Reboot & Apply</button>
        </div>
      </div>
      
      <!-- Logs Tab -->
      <div id="logs" class="tab-pane">
        <h2 style="margin-bottom: 20px; color: #667eea;">System Logs</h2>
        <div class="log-controls">
          <button onclick="clearLogs()">Clear Logs</button>
          <label>
            <input type="checkbox" id="autoscroll" checked>
            Auto-scroll
          </label>
          <label>
            <input type="checkbox" id="logpause">
            Pause
          </label>
        </div>
        <div class="log-viewer" id="logviewer"></div>
      </div>
      
      <!-- Firmware Tab -->
      <div id="firmware" class="tab-pane">
        <div class="section-title">Firmware Updates</div>
        <div class="form-group">
          <form id="firmwareForm" action="update?name=firmware" enctype="multipart/form-data" method="POST" onsubmit="return handleFirmwareUpdate(event)">
            <label>Firmware:</label>
            <input type="file" accept=".bin,.bin.gz" name="firmware" id="firmwareFile" style="margin-bottom: 10px;" required>
            <button type="submit" id="firmwareBtn">Update Firmware</button>
          </form>
        </div>
        
   <!-- <div class="form-group" style="margin-top: 20px;">
          <form id="filesystemForm" action="update?name=filesystem" enctype="multipart/form-data" method="POST" onsubmit="return handleFilesystemUpdate(event)">
            <label>FileSystem:</label>
            <input type="file" accept=".bin,.bin.gz" name="filesystem" id="filesystemFile" style="margin-bottom: 10px;" required>
            <button type="submit" id="filesystemBtn">Update FileSystem</button>
          </form>
        </div> -->
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    var gateway = `ws://${window.location.hostname}/ws`; 
    var websocket;
    const PIN_FIELDS = ['victronrxpin','victrontxpin','can_rx_pin','can_tx_pin','can_en_pin','canbuscspin','fanpin','onewirepin'];
    
    // Toggle password visibility
    function togglePassword(fieldId) {
      const input = document.getElementById(fieldId);
      const button = input.parentElement.querySelector('.password-toggle');
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'Hide';
      } else {
        input.type = 'password';
        button.textContent = 'Show';
      }
    }
    
    // Queue and debounce system
    const DEBOUNCE_DELAY = 400;
    const ACK_TIMEOUT = 5000;
    const MAX_RETRIES = 3;
    const sendQueue = [];
    const debounceTimers = {};
    const pendingAcks = {};
    let toastTimer = null;
    let savedWifiSSID = '';  // Store the currently saved WiFi SSID

    window.addEventListener('load', onLoad);

    function switchTab(event, tabName) {
      const panes = document.querySelectorAll('.tab-pane');
      panes.forEach(pane => pane.classList.remove('active'));
      
      const buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(btn => btn.classList.remove('active'));
      
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
      
      // Load buffered logs when Logs tab is opened
      if(tabName === 'logs' && websocket) {
        console.log('Logs tab opened. WebSocket state:', websocket.readyState);
        if(websocket.readyState === WebSocket.OPEN) {
          console.log('Requesting buffered logs...');
          websocket.send('GetLogs()');
        } else {
          console.warn('WebSocket not open, cannot request logs');
        }
      }
    }

    function initWebSocket() {
      console.log('Trying to open a WebSocket connection...');
      websocket = new WebSocket(gateway);
      websocket.onopen = onOpen;
      websocket.onclose = onClose;
      websocket.onmessage = onMessage;
      websocket.onerror = onError;
    }

    function onOpen(event) {
      console.log('WebSocket connection opened');
    }

    function onError(event) {
      console.error('WebSocket error:', event);
    }

    function onClose(event) {
      console.log('WebSocket connection closed. Code:', event.code, 'Reason:', event.reason);
      setTimeout(initWebSocket, 2000);
    }

    function onMessage(event) {
      const obj = JSON.parse(event.data);
      
      // Handle log messages
      if(obj.hasOwnProperty('log')) {
        addLogEntry(obj.log, obj.level || 'info');
        return;
      }
      
      // Log non-log messages only if verbose debugging needed
      // console.log(event.data);

      if(obj.hasOwnProperty('BMS') && obj.BMS) {
        if(obj.hasOwnProperty('chargevoltage')) { document.getElementById('chargevoltage').value=obj.chargevoltage; AckUpdate('chargevoltage'); }
        if(obj.hasOwnProperty('fullvoltage')) { document.getElementById('fullvoltage').value=obj.fullvoltage; AckUpdate('fullvoltage'); }
        if(obj.hasOwnProperty('minchargecurr')) { document.getElementById('minchargecurr').value=obj.minchargecurr; AckUpdate('minchargecurr'); }
        if(obj.hasOwnProperty('adjuststep')) { document.getElementById('adjuststep').value=obj.adjuststep; AckUpdate('adjuststep'); }
        if(obj.hasOwnProperty('smartinterval')) { document.getElementById('smartinterval').value=obj.smartinterval; AckUpdate('smartinterval'); }
        if(obj.hasOwnProperty('overvoltage')) { document.getElementById('overvoltage').value=obj.overvoltage; AckUpdate('overvoltage'); }
        if(obj.hasOwnProperty('dischargevoltage')) { document.getElementById('dischargevoltage').value=obj.dischargevoltage; AckUpdate('dischargevoltage'); }
        if(obj.hasOwnProperty('maxchargecurrent')) { document.getElementById('maxchargecurrent').value=obj.maxchargecurrent; AckUpdate('maxchargecurrent'); }
        if(obj.hasOwnProperty('maxdischargecurrent')) { document.getElementById('maxdischargecurrent').value=obj.maxdischargecurrent; AckUpdate('maxdischargecurrent'); }
        if(obj.hasOwnProperty('batterycapacity')) { document.getElementById('batterycapacity').value=obj.batterycapacity; AckUpdate('batterycapacity'); }
        if(obj.hasOwnProperty('lowsoclimit')) { document.getElementById('lowsoclimit').value=obj.lowsoclimit; AckUpdate('lowsoclimit'); }
        if(obj.hasOwnProperty('highsoclimit')) { document.getElementById('highsoclimit').value=obj.highsoclimit; AckUpdate('highsoclimit'); }
        if(obj.hasOwnProperty('velooptime')) { document.getElementById('velooptime').value=obj.velooptime; AckUpdate('velooptime'); }
        if(obj.hasOwnProperty('canbusenabled')) document.getElementById('canbusenabled').checked=obj.canbusenabled;
      }

      if(obj.hasOwnProperty('RealTime') && obj.RealTime) {
        // Update battery SOC and visual indicator
        if(obj.hasOwnProperty('battsoc')) {
          const soc = obj.battsoc;

          // Update battery visual
          const batteryLevel = document.getElementById('batteryLevel');
          const batteryPercentage = document.getElementById('batteryPercentage');

          if(batteryLevel && batteryPercentage) {
            batteryLevel.style.width = soc + '%';
            batteryPercentage.innerHTML = soc + '%';

            // Update battery color based on level
            batteryLevel.className = 'battery-level';
            if(soc <= 20) {
              batteryLevel.classList.add('low');
            } else if(soc <= 50) {
              batteryLevel.classList.add('medium');
            } else {
              batteryLevel.classList.add('high');
            }
          }

          // Show warning if SOC is low
          updateWarnings(soc, obj.chargeenabled, obj.dischargeenabled);
        }

        if(obj.hasOwnProperty('battvoltage')) document.getElementById('battvoltage').innerHTML=(obj.battvoltage*0.01).toFixed(1);

        // Update battery current and power flow indicator
        if(obj.hasOwnProperty('battcurrent')) {
          const current = obj.battcurrent * 0.1;
          const battCurrentElem = document.getElementById('battcurrent');
          if(battCurrentElem) {
            battCurrentElem.innerHTML = current.toFixed(1);
          }

          // Update battery wave animation and power flow indicator
          const batteryWave = document.getElementById('batteryWave');
          const flowText = document.getElementById('powerFlowText');

          if(batteryWave && flowText) {
            // Remove all classes first
            batteryWave.className = 'battery-wave';
            flowText.className = 'flow-text';

            if(current > 0.5) {
              // Charging
              batteryWave.classList.add('active', 'charging');
              flowText.classList.add('charging');
              flowText.innerHTML = '&#9650; Charging';
              flowText.style.color = '#4caf50';
            } else if(current < -0.5) {
              // Discharging
              batteryWave.classList.add('active', 'discharging');
              flowText.classList.add('discharging');
              flowText.innerHTML = '&#9660; Discharging';
              flowText.style.color = '#ff9800';
            } else {
              // Idle
              flowText.innerHTML = 'Idle';
              flowText.style.color = '#667eea';
            }
          }
        }

        if(obj.hasOwnProperty('chargecurrent')) document.getElementById('chargecurrent').innerHTML=(obj.chargecurrent*0.001).toFixed(0);
        if(obj.hasOwnProperty('dischargecurrent')) document.getElementById('dischargecurrent').innerHTML=(obj.dischargecurrent*0.001).toFixed(0);

        // Update Charge/Discharge enabled status with color coding
        if(obj.hasOwnProperty('chargeenabled')) {
          chargeEnabled = obj.chargeenabled;  // Track state for toggle
          let chargeStatus = document.getElementById('chargeenabledStatus');
          chargeStatus.innerHTML = obj.chargeenabled ? 'ON' : 'OFF';
          chargeStatus.style.color = obj.chargeenabled ? '#4caf50' : '#f44336';
        }
        if(obj.hasOwnProperty('dischargeenabled')) {
          dischargeEnabled = obj.dischargeenabled;  // Track state for toggle
          let dischargeStatus = document.getElementById('dischargeenabledStatus');
          dischargeStatus.innerHTML = obj.dischargeenabled ? 'ON' : 'OFF';
          dischargeStatus.style.color = obj.dischargeenabled ? '#4caf50' : '#f44336';
        }

        // Update last update timestamp
        const lastUpdateElem = document.getElementById('lastUpdate');
        if(lastUpdateElem) {
          const now = new Date().toLocaleTimeString();
          lastUpdateElem.textContent = now;
        }
      }

      if(obj.hasOwnProperty('soctrickenabled')) document.getElementById('soctrickenabled').checked=obj.soctrickenabled;
      if(obj.hasOwnProperty('requestflagsenabled')) document.getElementById('requestflagsenabled').checked=obj.requestflagsenabled;
      if(obj.hasOwnProperty('autocharge')) document.getElementById('autocharge').checked=obj.autocharge;
      if(obj.hasOwnProperty('wifissid')) { 
        // Save the SSID as the current saved network
        savedWifiSSID = obj.wifissid;
        console.log("Updated saved WiFi SSID: " + savedWifiSSID);
        // Set the selected SSID in dropdown
        var select = document.getElementById('wifissid');
        select.value = obj.wifissid;
        // If dropdown is empty or doesn't have this SSID option, create it
        if(select.value !== obj.wifissid) {
          var el = document.createElement('option');
          el.textContent = obj.wifissid;
          el.value = obj.wifissid;
          el.selected = true;
          select.appendChild(el);
        }
        AckUpdate('wifissid');
      }
      if(obj.hasOwnProperty('wifipass')) { document.getElementById('wifipass').value=obj.wifipass; AckUpdate('wifipass'); }
      if(obj.hasOwnProperty('wifihostname')) { document.getElementById('wifihostname').value=obj.wifihostname; AckUpdate('wifihostname'); }
      if(obj.hasOwnProperty('victronrxpin')) { document.getElementById('victronrxpin').value=obj.victronrxpin; AckUpdate('victronrxpin'); }
      if(obj.hasOwnProperty('victrontxpin')) { document.getElementById('victrontxpin').value=obj.victrontxpin; AckUpdate('victrontxpin'); }
      {{CAN_FIELD_HANDLERS}}
      if(obj.hasOwnProperty('mqttport')) { document.getElementById('mqttport').value=obj.mqttport; AckUpdate('mqttport'); }
      if(obj.hasOwnProperty('mqttserverip')) { document.getElementById('mqttserverip').value=obj.mqttserverip; AckUpdate('mqttserverip'); }
      if(obj.hasOwnProperty('mqttclientid')) { document.getElementById('mqttclientid').value=obj.mqttclientid; AckUpdate('mqttclientid'); }
      if(obj.hasOwnProperty('mqtttopic')) { document.getElementById('mqtttopic').value=obj.mqtttopic; AckUpdate('mqtttopic'); }
      if(obj.hasOwnProperty('mqttparameter')) { document.getElementById('mqttparameter').value=obj.mqttparameter; AckUpdate('mqttparameter'); }
      if(obj.hasOwnProperty('mqttuser')) { document.getElementById('mqttuser').value=obj.mqttuser; AckUpdate('mqttuser'); }
      if(obj.hasOwnProperty('mqttpass')) { document.getElementById('mqttpass').value=obj.mqttpass; AckUpdate('mqttpass'); }
      if(obj.hasOwnProperty('slowchargesoc1')) { document.getElementById('slowchargesoc1').value=obj.slowchargesoc1; AckUpdate('slowchargesoc1'); }
      if(obj.hasOwnProperty('slowchargesoc2')) { document.getElementById('slowchargesoc2').value=obj.slowchargesoc2; AckUpdate('slowchargesoc2'); }
      if(obj.hasOwnProperty('slowchargesoc1div')) { document.getElementById('slowchargesoc1div').value=obj.slowchargesoc1div; AckUpdate('slowchargesoc1div'); }
      if(obj.hasOwnProperty('slowchargesoc2div')) { document.getElementById('slowchargesoc2div').value=obj.slowchargesoc2div; AckUpdate('slowchargesoc2div'); }
      if(obj.hasOwnProperty('lcdenabled')) document.getElementById('lcdenabled').checked=obj.lcdenabled;
      if(obj.hasOwnProperty('ntpserver')) { document.getElementById('ntpserver').value=obj.ntpserver; AckUpdate('ntpserver'); }
      {{FAN_PIN_HANDLER}}

      // Handle WiFi scan results from WebSocket
      if(obj.hasOwnProperty('wifinetworks')) {
        PopulateWifiList(obj.wifinetworks);
      }

      if(obj.hasOwnProperty('Message')) alert(obj.Message);
      if(obj.hasOwnProperty('ERROR')) alert(obj.ERROR);
    }

    function onLoad(event) {
      initWebSocket();
    }


    function setUpdateButtonsDisabled(disabled) {
      const buttons = document.querySelectorAll('.button-group button, .wifi-controls button');
      buttons.forEach(button => {
        button.disabled = disabled;
        if (disabled) {
          button.style.opacity = '0.5';
          button.style.cursor = 'not-allowed';
        } else {
          button.style.opacity = '1';
          button.style.cursor = 'pointer';
        }
      });
    }

    function saveAll() {
      console.log('Sending Save All command');
      setUpdateButtonsDisabled(true);
      showFeedback('Saving configuration...');
      var jsonobj = '{"saveall" : true}';
      websocket.send(jsonobj);
      setTimeout(() => setUpdateButtonsDisabled(false), 2000);
    }

    function eraseAll() {
      if (!confirm('Are you sure? This will erase all settings.')) return;
      console.log('Sending Erase All (EEPROM) command');
      setUpdateButtonsDisabled(true);
      showFeedback('Erasing configuration...');
      var jsonobj = '{"eraseall" : true}';
      websocket.send(jsonobj);
      setTimeout(() => setUpdateButtonsDisabled(false), 2000);
    }

    function erasekeepwifi() {
      if (!confirm('Are you sure? This will erase settings but keep WiFi.')) return;
      console.log('Sending Erase All Keep Wifi (EEPROM) command');
      setUpdateButtonsDisabled(true);
      showFeedback('Erasing configuration (keeping WiFi)...');
      var jsonobj = '{"erasekeepwifi" : true}';
      websocket.send(jsonobj);
      setTimeout(() => setUpdateButtonsDisabled(false), 2000);
    }

    function rebootBMS() {
      if (!confirm('Reboot device?')) return;
      console.log('Sending Reboot command');
      setUpdateButtonsDisabled(true);
      showFeedback('Rebooting device...');
      var jsonobj = '{"reboot" : true}';
      websocket.send(jsonobj);
      setTimeout(() => setUpdateButtonsDisabled(false), 3000);
    }

    // Track current charge/discharge enable states
    let chargeEnabled = false;
    let dischargeEnabled = false;

    function toggleChargeEnable() {
      chargeEnabled = !chargeEnabled;
      console.log('Toggling Charge Enable to: ' + chargeEnabled);
      showFeedback(chargeEnabled ? 'Enabling charge...' : 'Disabling charge...');
      websocket.send(JSON.stringify({"manualallowcharge": chargeEnabled}));
    }

    function toggleDischargeEnable() {
      dischargeEnabled = !dischargeEnabled;
      console.log('Toggling Discharge Enable to: ' + dischargeEnabled);
      showFeedback(dischargeEnabled ? 'Enabling discharge...' : 'Disabling discharge...');
      websocket.send(JSON.stringify({"manualallowdischarge": dischargeEnabled}));
    }

    function showFeedback(message) {
      let feedback = document.getElementById('updateFeedback');
      if (!feedback) {
        feedback = document.createElement('div');
        feedback.id = 'updateFeedback';
        feedback.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #2196F3; color: white; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10000;';
        document.body.appendChild(feedback);
      }
      feedback.innerHTML = message;
      feedback.style.display = 'block';
      setTimeout(() => feedback.style.display = 'none', 2500);
    }

    function handleFirmwareUpdate(event) {
      const fileInput = document.getElementById('firmwareFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showFeedback('Please select a firmware file');
        return false;
      }
      
      if (!file.name.endsWith('.bin') && !file.name.endsWith('.bin.gz')) {
        showFeedback('Invalid file type. Please use .bin or .bin.gz');
        return false;
      }
      
      if (file.size > 4194304) { // 4MB limit
        showFeedback('Firmware file too large (max 4MB)');
        return false;
      }
      
      const btn = document.getElementById('firmwareBtn');
      btn.disabled = true;
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
      
      showFeedback('Uploading firmware... This may take 1-2 minutes. Do not close browser.');
      console.log('Firmware update started - ' + file.name);
      
      return true; // Allow form submission
    }

    function handleFilesystemUpdate(event) {
      const fileInput = document.getElementById('filesystemFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showFeedback('Please select a filesystem file');
        return false;
      }
      
      if (!file.name.endsWith('.bin') && !file.name.endsWith('.bin.gz')) {
        showFeedback('Invalid file type. Please use .bin or .bin.gz');
        return false;
      }
      
      if (file.size > 4194304) { // 4MB limit for filesystem
        showFeedback('Filesystem file too large (max 4MB)');
        return false;
      }
      
      const btn = document.getElementById('filesystemBtn');
      btn.disabled = true;
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
      
      showFeedback('Uploading filesystem... Please wait. Do not close browser.');
      console.log('Filesystem update started - ' + file.name);
      
      return true; // Allow form submission
    }

    function showToast(message, status = 'success', duration = 1800) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = message;
      toast.classList.remove('success', 'pending', 'error');
      toast.classList.add(status, 'show');
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), duration);
    }

    function HandleEnter(event, fieldId) {
      if (event.key === 'Enter') {
        event.preventDefault();
        if(fieldId === 'SaveWifiConfig') {
          SaveWifiConfig();
        } else {
          SendQueuedUpdate(fieldId);
        }
      }
    }

    function SaveWifiConfig() {
      // Collect WiFi configuration values
      const wifissid = document.getElementById('wifissid').value;
      const wifipass = document.getElementById('wifipass').value;
      const wifihostname = document.getElementById('wifihostname').value;
      
      // Validate that at least SSID is provided
      if(!wifissid || wifissid.trim() === '') {
        showToast('Please select a WiFi network', 'error');
        return;
      }
      
      if(!wifipass || wifipass.trim() === '') {
        showToast('Please enter a WiFi password', 'error');
        return;
      }
      
      // Send WiFi configuration via JSON
      const payload = {
        wifissid: wifissid,
        wifipass: wifipass,
        wifihostname: wifihostname
      };
      
      const jsonString = JSON.stringify(payload);
      console.log('Saving WiFi config: ' + jsonString);
      showToast('Saving WiFi configuration...', 'pending');
      
      // Send directly to WebSocket without queuing
      if(websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(jsonString);
      } else {
        showToast('WebSocket not connected', 'error');
      }
    }

    function EnqueueUpdate(fieldId) {
      if (debounceTimers[fieldId]) clearTimeout(debounceTimers[fieldId]);
      debounceTimers[fieldId] = setTimeout(() => SendQueuedUpdate(fieldId), DEBOUNCE_DELAY);
    }

    function SendQueuedUpdate(fieldId) {
      if (debounceTimers[fieldId]) clearTimeout(debounceTimers[fieldId]);
      delete debounceTimers[fieldId];

      const element = document.getElementById(fieldId);
      if (!element) {
        console.log('Element not found: ' + fieldId);
        return;
      }

      const rawValue = element.value;
      const trimmed = (rawValue === undefined || rawValue === null) ? '' : rawValue.toString().trim();
      const isPinField = PIN_FIELDS.includes(fieldId);

      let payload;

      if (fieldId === 'wifissid') {
        payload = { [fieldId]: element.options[element.selectedIndex].value };
      } else if (element.type === 'checkbox') {
        payload = { [fieldId]: element.checked };
      } else {
        if (trimmed === '') {
          if (element.type === 'number' || isPinField) {
            console.log('Ignoring empty value for ' + fieldId);
            return;
          }
          payload = { [fieldId]: '' };
        } else {
          if (isPinField) {
            const parsedPin = Number(trimmed);
            if (!Number.isFinite(parsedPin) || parsedPin <= 0) {
              console.log('Ignoring invalid/zero pin value for ' + fieldId);
              return;
            }
          }

          const numericValue = Number(trimmed);
          if (!Number.isNaN(numericValue)) {
            payload = { [fieldId]: numericValue };
          } else {
            payload = { [fieldId]: trimmed };
          }
        }
      }

      const item = {
        id: fieldId,
        payload: payload,
        retries: 0
      };

      sendQueue.push(item);
      ProcessQueue();
    }

    function ProcessQueue() {
      if (sendQueue.length === 0) return;
      if (Object.keys(pendingAcks).length > 0) return; // Wait for current ack

      const item = sendQueue.shift();
      const jsonString = JSON.stringify(item.payload);
      console.log('Sending to WebSocket: ' + jsonString);
      showToast('Saving...', 'pending');

      pendingAcks[item.id] = {
        timeout: setTimeout(() => {
          delete pendingAcks[item.id];
          if (item.retries < MAX_RETRIES) {
            item.retries++;
            sendQueue.unshift(item);
            console.log('Retry ' + item.retries + ' for ' + item.id);
            ProcessQueue();
          } else {
            showToast('Failed to save ' + item.id, 'error', 2500);
            ProcessQueue();
          }
        }, ACK_TIMEOUT),
        item: item
      };

      websocket.send(jsonString);
    }

    function AckUpdate(fieldId) {
      if (pendingAcks[fieldId]) {
        clearTimeout(pendingAcks[fieldId].timeout);
        delete pendingAcks[fieldId];
        showToast('Saved', 'success');
        ProcessQueue();
      }
    }

    function updateWarnings(soc, chargeEnabled, dischargeEnabled) {
      const warningsDiv = document.getElementById('statusWarnings');
      const warningText = document.getElementById('warningText');
      let warnings = [];

      // Check for low battery
      if(soc <= 20) {
        warnings.push('Low battery: ' + soc + '%');
      }

      // Check if charging/discharging is disabled
      if(!chargeEnabled && soc < 80) {
        warnings.push('Charging disabled');
      }

      if(!dischargeEnabled && soc > 20) {
        warnings.push('Discharge disabled');
      }

      // Display warnings if any
      if(warnings.length > 0) {
        warningText.innerHTML = warnings.join('  ');
        warningsDiv.style.display = 'block';

        // Make it error style if SOC is critically low
        if(soc <= 10) {
          warningsDiv.className = 'status-warnings error';
        } else {
          warningsDiv.className = 'status-warnings';
        }
      } else {
        warningsDiv.style.display = 'none';
      }
    }

    function addLogEntry(message, level) {
      if(document.getElementById('logpause').checked) return;
      
      const logViewer = document.getElementById('logviewer');
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + level;
      
      const timestamp = new Date().toLocaleTimeString('en-GB', { hour12: false });
      entry.textContent = `[${timestamp}] ${message}`;
      
      logViewer.appendChild(entry);
      
      // Keep only last 500 entries
      while(logViewer.children.length > 500) {
        logViewer.removeChild(logViewer.firstChild);
      }
      
      // Auto-scroll to bottom if enabled
      if(document.getElementById('autoscroll').checked) {
        logViewer.scrollTop = logViewer.scrollHeight;
      }
    }
    
    function clearLogs() {
      document.getElementById('logviewer').innerHTML = '';
    }
    
    function GetWifiList() {
      console.log("Requesting WiFi scan");
      // Save the currently selected SSID before clearing
      var select = document.getElementById('wifissid');
      if(select.value && select.value !== 'Please Wait...') {
        savedWifiSSID = select.value;
        console.log("Saved current WiFi SSID: " + savedWifiSSID);
      }
      // Show "Please Wait" in the dropdown - make it selected so it displays
      select.innerHTML = '';
      var el = document.createElement('option');
      el.textContent = 'Please Wait...';
      el.disabled = true;
      el.selected = true;  // Make it selected so it shows
      select.appendChild(el);
      // Send request via WebSocket
      websocket.send('GetWifiScan()');
      // The results will arrive asynchronously via the wifinetworks message
    }
    
    function DedupeNetworks(networks) {
      // Create a map to store the best signal strength for each SSID
      const ssidMap = {};
      
      networks.forEach(network => {
        if(network.ssid) {
          // Keep the network with the strongest signal (highest RSSI value)
          if(!ssidMap[network.ssid] || network.rssi > ssidMap[network.ssid].rssi) {
            ssidMap[network.ssid] = network;
          }
        }
      });
      
      // Convert map back to array and sort by signal strength (strongest first)
      const deduped = Object.values(ssidMap).sort((a, b) => {
        // Sort by RSSI in descending order (higher signal strength first)
        return b.rssi - a.rssi;
      });
      
      console.log("Deduplicated networks: " + networks.length + " -> " + deduped.length);
      return deduped;
    }
    
    function PopulateWifiList(networks) {
      console.log("Populating WiFi list with " + networks.length + " networks");
      
      // Deduplicate networks, keeping the one with best signal for each SSID
      const deduped = DedupeNetworks(networks);
      
      var select = document.getElementById("wifissid");
      document.getElementById('wifissid').innerHTML = '';

      deduped.forEach(network => {
        var el = document.createElement("option");
        el.textContent = network.ssid;
        el.value = network.ssid;
        el.className = "dropdown-item";
        
        // Select this option if it matches the saved SSID
        if(network.ssid === savedWifiSSID) {
          el.selected = true;
          console.log("Selected saved WiFi: " + network.ssid);
        }
        
        select.appendChild(el);
        console.log('Adding WiFi Option: ' + network.ssid + ' (RSSI: ' + network.rssi + ')'); 
      });
      
      if(deduped.length === 0) {
        console.log('No WiFi networks found');
      }
    }
  </script>
</body>
</html>
